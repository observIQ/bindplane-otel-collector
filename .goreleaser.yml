version: 2

project_name: bindplane-otel-collector

before:
  hooks:
    - make release-prep-gpg CURR_VERSION={{ .Version }}
    - make build-all-non-aix OUTDIR="tmp"

after:
  hooks:
    - cmd: rm -rf tmp

# https://goreleaser.com/customization/build/
builds:
  # https://goreleaser.com/customization/builds/#import-pre-built-binaries
  - id: collector
    builder: prebuilt
    binary: bindplane-otel-collector
    mod_timestamp: "{{ .CommitTimestamp }}"
    tags:
      - bindplane
    goos:
      - darwin
      - linux
      - windows
    goarch:
      - amd64
      - arm64
      - ppc64
      - ppc64le
    ignore:
      - goos: darwin
        goarch: ppc64
      - goos: darwin
        goarch: ppc64le
      - goos: windows
        goarch: arm64
      - goos: windows
        goarch: ppc64
      - goos: windows
        goarch: ppc64le
    prebuilt:
      path: tmp/collector_{{ .Os }}_{{ .Arch }}{{ .Ext }}
  - id: supervisor
    builder: prebuilt
    binary: opampsupervisor
    goos:
      - darwin
      - linux
      - windows
    goarch:
      - amd64
      - arm64
      - ppc64
      - ppc64le
    ignore:
      - goos: darwin
        goarch: ppc64
      - goos: darwin
        goarch: ppc64le
      - goos: windows
        goarch: arm64
      - goos: windows
        goarch: ppc64
      - goos: windows
        goarch: ppc64le
    prebuilt:
      path: release_deps/supervisor_bin/opampsupervisor_{{ .Os }}_{{ .Arch }}{{ .Ext }}
    no_unique_dist_dir: false

# https://goreleaser.com/customization/archive/
archives:
  - format: tar.gz
    name_template: "{{ .ProjectName }}-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
    files:
      - LICENSE
      - src: release_deps/plugins/*
        dst: plugins
        strip_parent: true
      - src: release_deps/VERSION.txt
        dst: "."
        strip_parent: true
      - src: release_deps/com.bindplane.otel.collector.plist
        dst: "install"
        strip_parent: true
      - src: release_deps/gpg-keys.tar.gz
        dst: "."
        strip_parent: true
      - src: release_deps/bindplane-otel-collector
        dst: "install"
        strip_parent: true
    format_overrides:
      - goos: windows
        format: zip

nfpms:
  - id: collector
    ids:
      - collector
      - supervisor
    file_name_template: "{{ .PackageName }}_v{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    package_name: bindplane-otel-collector
    vendor: observIQ, Inc
    maintainer: observIQ <support@observiq.com>
    description: The BindPlane Distro for OpenTelemetry Collector.
    homepage: https://github.com/observIQ/bindplane-otel-collector
    license: Apache 2.0
    formats:
      - rpm
      - deb
    bindir: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector
    deb:
      signature:
        key_file: "{{ .Env.SIGNING_KEY_FILE }}"
    rpm:
      signature:
        key_file: "{{ .Env.SIGNING_KEY_FILE }}"
    contents:
      - dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector
        type: dir
        file_info:
          mode: 0750
          owner: root
          group: root
      - src: LICENSE
        dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/LICENSE
        file_info:
          mode: 0644
          owner: root
          group: root
      - src: release_deps/VERSION.txt
        dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/VERSION.txt
        file_info:
          mode: 0644
          owner: root
          group: root
      - dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/plugins
        type: dir
        file_info:
          mode: 0750 # restrict plugins to owner / group only
          owner: root
          group: root
      # Note: plugins owner/group/mode is set in the post-install script
      # Attempting to set the permissions here results in the following error:
      # nfpm failed: cannot write header of release_deps/plugins/amazon_eks.yaml to data.tar.gz: archive/tar: missed writing 1736 bytes
      - src: release_deps/plugins/*
        dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/plugins
      # Storage dir is used by stateful receivers, such as filelog receiver. It allows
      # receivers to track their progress and buffer data.
      - src: config/supervisor-default.yaml
        dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/supervisor.yaml
        file_info:
          mode: 0750
          owner: root
          group: root
      - dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/storage
        type: dir
        file_info:
          mode: 0750
          owner: root
          group: root
      - dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/supervisor_storage
        type: dir
        file_info:
          mode: 0750
          owner: root
          group: root
      - dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/supervisor_storage/effective.yaml
        type: ghost
      - dst: /usr/share/bindplane-otel-collector/stage/bindplane-otel-collector/supervisor_storage/agent.log
        type: ghost
    scripts:
      preinstall: ./scripts/package/preinstall.sh
      postinstall: ./scripts/package/postinstall.sh
      preremove: ./scripts/package/preremove.sh
      postremove: ./scripts/package/postremove.sh

  # TODO: Dakota - commenting out during v2 alpha releases
  # Build container images with docker buildx (mutli arch builds).
dockers:
  # TODO: Consider removing later, used for alpha v2 releases
  - id: ubuntu-amd64
    goos: linux
    goarch: amd64
    retry:
      attempts: 10
      delay: 30s
      max_delay: 1m
    ids:
      - collector
      - supervisor
    image_templates:
      - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .RawVersion }}-{{ .Prerelease }}"
    dockerfile: ./docker/Dockerfile.ubuntu
    use: buildx
    build_flag_templates:
      - "--label=created={{.Date}}"
      - "--label=title={{.ProjectName}}"
      - "--label=revision={{.FullCommit}}"
      - "--label=version={{.Version}}"
      - "--platform=linux/amd64"
    extra_files:
      - release_deps/VERSION.txt
      - release_deps/plugins
      - LICENSE
  # TODO: Consider removing later, used for alpha v2 releases
  - id: ubuntu-arm64
    goos: linux
    goarch: arm64
    retry:
      attempts: 10
      delay: 30s
      max_delay: 1m
    ids:
      - collector
      - supervisor
    image_templates:
      - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .RawVersion }}-{{ .Prerelease }}"
    dockerfile: ./docker/Dockerfile.ubuntu
    use: buildx
    build_flag_templates:
      - "--label=created={{.Date}}"
      - "--label=title={{.ProjectName}}"
      - "--label=revision={{.FullCommit}}"
      - "--label=version={{.Version}}"
      - "--platform=linux/arm64"
    extra_files:
      - release_deps/VERSION.txt
      - release_deps/plugins
      - LICENSE
  # JMX builds, commented out for now, maybe add back later. If added back, these will need to be updated to actually match V2 instead of just being copy-pasted from V1
  # - id: ubuntu-jmx-amd64
  #   goos: linux
  #   goarch: amd64
  #   retry:
  #     attempts: 10
  #     delay: 30s
  #     max_delay: 1m
  #   ids:
  #     - collector
  #   image_templates:
  #     - "observiq/observiq-otel-collector-amd64:{{ .Version }}-jmx"
  #     - "ghcr.io/observiq/observiq-otel-collector-amd64:{{ .Version }}-jmx"
  #     - "us-central1-docker.pkg.dev/observiq-containers/collector/observiq-otel-collector-amd64:{{ .Version }}-jmx"
  #     # Bindplane Agent Containers
  #     - "observiq/bindplane-agent-amd64:{{ .Version }}-jmx"
  #     - "ghcr.io/observiq/bindplane-agent-amd64:{{ .Version }}-jmx"
  #     - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-agent-amd64:{{ .Version }}-jmx"
  #   dockerfile: ./docker/Dockerfile.jmx
  #   use: buildx
  #   build_flag_templates:
  #     - "--label=created={{.Date}}"
  #     - "--label=title={{.ProjectName}}"
  #     - "--label=revision={{.FullCommit}}"
  #     - "--label=version={{.Version}}"
  #     - "--platform=linux/amd64"
  #   extra_files:
  #     - release_deps/VERSION.txt
  #     - release_deps/plugins
  #     - release_deps/config.yaml
  #     - config/logging.stdout.yaml
  #     - LICENSE
  #     - release_deps/opentelemetry-java-contrib-jmx-metrics.jar
  # - id: ubuntu-jmx-arm64
  #   goos: linux
  #   goarch: arm64
  #   retry:
  #     attempts: 10
  #     delay: 30s
  #     max_delay: 1m
  #   ids:
  #     - collector
  #   image_templates:
  #     - "observiq/observiq-otel-collector-arm64:{{ .Version }}-jmx"
  #     - "ghcr.io/observiq/observiq-otel-collector-arm64:{{ .Version }}-jmx"
  #     - "us-central1-docker.pkg.dev/observiq-containers/collector/observiq-otel-collector-arm64:{{ .Version }}-jmx"
  #     # Bindplane Agent Containers
  #     - "observiq/bindplane-agent-arm64:{{ .Version }}-jmx"
  #     - "ghcr.io/observiq/bindplane-agent-arm64:{{ .Version }}-jmx"
  #     - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-agent-arm64:{{ .Version }}-jmx"
  #   dockerfile: ./docker/Dockerfile.jmx
  #   use: buildx
  #   build_flag_templates:
  #     - "--label=created={{.Date}}"
  #     - "--label=title={{.ProjectName}}"
  #     - "--label=revision={{.FullCommit}}"
  #     - "--label=version={{.Version}}"
  #     - "--platform=linux/arm64"
  #   extra_files:
  #     - release_deps/VERSION.txt
  #     - release_deps/plugins
  #     - release_deps/config.yaml
  #     - config/logging.stdout.yaml
  #     - LICENSE
  #     - release_deps/opentelemetry-java-contrib-jmx-metrics.jar
  # - id: ubuntu-jmx-ppc64le
  #   goos: linux
  #   goarch: ppc64le
  #   retry:
  #     attempts: 10
  #     delay: 30s
  #     max_delay: 1m
  #   ids:
  #     - collector
  #   image_templates:
  #     - "observiq/observiq-otel-collector-ppc64le:{{ .Version }}-jmx"
  #     - "ghcr.io/observiq/observiq-otel-collector-ppc64le:{{ .Version }}-jmx"
  #     - "us-central1-docker.pkg.dev/observiq-containers/collector/observiq-otel-collector-ppc64le:{{ .Version }}-jmx"
  #     # Bindplane Agent Containers
  #     - "observiq/bindplane-agent-ppc64le:{{ .Version }}-jmx"
  #     - "ghcr.io/observiq/bindplane-agent-ppc64le:{{ .Version }}-jmx"
  #     - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-agent-ppc64le:{{ .Version }}-jmx"
  #   dockerfile: ./docker/Dockerfile.jmx
  #   use: buildx
  #   build_flag_templates:
  #     - "--label=created={{.Date}}"
  #     - "--label=title={{.ProjectName}}"
  #     - "--label=revision={{.FullCommit}}"
  #     - "--label=version={{.Version}}"
  #     - "--platform=linux/ppc64le"
  #   extra_files:
  #     - release_deps/VERSION.txt
  #     - release_deps/plugins
  #     - release_deps/config.yaml
  #     - config/logging.stdout.yaml
  #     - LICENSE
  #     - release_deps/opentelemetry-java-contrib-jmx-metrics.jar
  # END JMX BUILDS
#   - id: scratch-amd64
#     goos: linux
#     goarch: amd64
#     ids:
#       - collector
#       - supervisor
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}-minimal"
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}-minimal"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:{{ .Version }}-minimal"
#     dockerfile: ./docker/Dockerfile.scratch
#     use: buildx
#     build_flag_templates:
#       - "--label=created={{.Date}}"
#       - "--label=title={{.ProjectName}}"
#       - "--label=revision={{.FullCommit}}"
#       - "--label=version={{.Version}}"
#       - "--platform=linux/amd64"
#     extra_files:
#       - release_deps/VERSION.txt
#       - release_deps/plugins
#       - LICENSE
#   - id: scratch-arm64
#     goos: linux
#     goarch: arm64
#     ids:
#       - collector
#       - supervisor
#     image_templates:
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}-minimal"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}-minimal"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:{{ .Version }}-minimal"
#     dockerfile: ./docker/Dockerfile.scratch
#     use: buildx
#     build_flag_templates:
#       - "--label=created={{.Date}}"
#       - "--label=title={{.ProjectName}}"
#       - "--label=revision={{.FullCommit}}"
#       - "--label=version={{.Version}}"
#       - "--platform=linux/arm64"
#     extra_files:
#       - release_deps/VERSION.txt
#       - release_deps/plugins
#       - LICENSE
#   - id: ubuntu-amd64
#     goos: linux
#     goarch: amd64
#     ids:
#       - collector
#       - supervisor
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:latest"
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:latest"
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-amd64:latest"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-amd64:{{ .Version }}"
#       # BDOT Containers
#       - "observiq/bindplane-otel-collector-amd64:latest"
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:latest"
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:latest"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:{{ .Version }}"
#     dockerfile: ./docker/Dockerfile.ubuntu
#     use: buildx
#     build_flag_templates:
#       - "--label=created={{.Date}}"
#       - "--label=title={{.ProjectName}}"
#       - "--label=revision={{.FullCommit}}"
#       - "--label=version={{.Version}}"
#       - "--platform=linux/amd64"
#     extra_files:
#       - release_deps/VERSION.txt
#       - release_deps/plugins
#       - LICENSE
#       - release_deps/opentelemetry-java-contrib-jmx-metrics.jar
#   - id: ubuntu-arm64
#     goos: linux
#     goarch: arm64
#     ids:
#       - collector
#       - supervisor
#     image_templates:
#       - "observiq/bindplane-otel-collector-arm64:latest"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:latest"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-arm64:latest"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-arm64:{{ .Version }}"
#       # BDOT Containers
#       - "observiq/bindplane-otel-collector-arm64:latest"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:latest"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:latest"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:{{ .Version }}"
#     dockerfile: ./docker/Dockerfile.ubuntu
#     use: buildx
#     build_flag_templates:
#       - "--label=created={{.Date}}"
#       - "--label=title={{.ProjectName}}"
#       - "--label=revision={{.FullCommit}}"
#       - "--label=version={{.Version}}"
#       - "--platform=linux/arm64"
#     extra_files:
#       - release_deps/VERSION.txt
#       - release_deps/plugins
#       - LICENSE
#       - release_deps/opentelemetry-java-contrib-jmx-metrics.jar

docker_manifests:
  # TODO: Consider removing later, used for alpha v2 releases
  - name_template: "ghcr.io/observiq/bindplane-otel-collector:{{ .RawVersion }}-{{ .Prerelease }}"
    image_templates:
      - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .RawVersion }}-{{ .Prerelease }}"
      - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .RawVersion }}-{{ .Prerelease }}"
    skip_push: false
#   - name_template: "observiq/bindplane-otel-collector:{{ .Version }}-minimal"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}-minimal"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}-minimal"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:{{ .Version }}-minimal"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}-minimal"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}-minimal"
#     skip_push: false
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector:{{ .Version }}-minimal"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:{{ .Version }}-minimal"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:{{ .Version }}-minimal"
#     skip_push: false
#   - name_template: "observiq/bindplane-otel-collector:latest"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:latest"
#       - "observiq/bindplane-otel-collector-arm64:latest"
#     skip_push: false
#   - name_template: "observiq/bindplane-otel-collector:{{ .Version }}"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#     skip_push: false
#   - name_template: "observiq/bindplane-otel-collector:{{ .Version }}-ubi8"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}-ubi8"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}-ubi8"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:latest"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:latest"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:latest"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:{{ .Version }}"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:{{ .Version }}-ubi8"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}-ubi8"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}-ubi8"
#     skip_push: false
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector:latest"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-amd64:latest"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-arm64:latest"
#     skip_push: false
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector:{{ .Version }}"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-arm64:{{ .Version }}"
#     skip_push: false
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector:{{ .Version }}-ubi8"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-amd64:{{ .Version }}-ubi8"
#       - "us-central1-docker.pkg.dev/observiq-containers/collector/bindplane-otel-collector-arm64:{{ .Version }}-ubi8"
#     skip_push: false
#   # BDOT Manifests
#   - name_template: "observiq/bindplane-otel-collector:latest"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:latest"
#       - "observiq/bindplane-otel-collector-arm64:latest"
#     skip_push: false
#   - name_template: "observiq/bindplane-otel-collector:{{ .Version }}"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#     skip_push: false
#   - name_template: "observiq/bindplane-otel-collector:{{ .Version }}-ubi8"
#     image_templates:
#       - "observiq/bindplane-otel-collector-amd64:{{ .Version }}-ubi8"
#       - "observiq/bindplane-otel-collector-arm64:{{ .Version }}-ubi8"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:latest"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:latest"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:latest"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:{{ .Version }}"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}"
#     skip_push: false
#   - name_template: "ghcr.io/observiq/bindplane-otel-collector:{{ .Version }}-ubi8"
#     image_templates:
#       - "ghcr.io/observiq/bindplane-otel-collector-amd64:{{ .Version }}-ubi8"
#       - "ghcr.io/observiq/bindplane-otel-collector-arm64:{{ .Version }}-ubi8"
#     skip_push: false
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector:latest"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:latest"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:latest"
#     skip_push: false
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector:{{ .Version }}"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:{{ .Version }}"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:{{ .Version }}"
#     skip_push: falses
#   - name_template: "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector:{{ .Version }}-ubi8"
#     image_templates:
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-amd64:{{ .Version }}-ubi8"
#       - "us-central1-docker.pkg.dev/observiq-containers/agent/bindplane-otel-collector-arm64:{{ .Version }}-ubi8"
#     skip_push: false

# https://goreleaser.com/customization/checksum/
checksum:
  name_template: "{{ .ProjectName }}-v{{ .Version }}-SHA256SUMS"
  algorithm: sha256
  extra_files:
    - glob: "./bindplane-otel-collector.msi"
    - glob: "./dist/*.zip"

# https://goreleaser.com/customization/sign/
signs:
  - cmd: cosign
    stdin: "{{ .Env.COSIGN_PWD }}"
    args:
      ["sign-blob", "--key=cosign.key", "--output=${signature}", "${artifact}"]
    artifacts: all

# TODO(dakota): commented out because it is causing release to fail with goreleaser v2... not sure why though
# https://goreleaser.com/customization/docker_sign/
# Uses Cosign by default, signs images and manifests.
# docker_signs:
#   - artifacts: all
#     stdin: "{{ .Env.COSIGN_PWD }}"
#     args: [
#       # Default options
#       "sign",
#       "--key=cosign.key",
#       "${artifact}",
#       "--yes",
#       # Additional options
#       "--recursive"
#     ]
#     output: true

# https://goreleaser.com/customization/release/
release:
  draft: false

  # publish to a prerelease first
  prerelease: "true"
  extra_files:
    - glob: "./bindplane-otel-collector*.msi"
    - glob: "./bindplane-otel-collector*.msi.sig"
    - glob: "./scripts/install/install_unix.sh"
    - glob: "./scripts/install/install_macos.sh"
    - glob: "./release_deps/gpg-keys.tar.gz"
    - glob: "./dist/*.zip"
    - glob: "./dist/*.zip.sig"

# https://console.cloud.google.com/storage/browser/bdot-release
blobs:
  - provider: gs
    bucket: bdot-release
    directory: "v{{ .Version }}"
    extra_files:
      - glob: "./bindplane-otel-collector*.msi"
      - glob: "./bindplane-otel-collector*.msi.sig"
      - glob: "./scripts/install/install_unix.sh"
      - glob: "./scripts/install/install_macos.sh"
      - glob: "./release_deps/gpg-keys.tar.gz"
      - glob: "./dist/*.zip"
      - glob: "./dist/*.zip.sig"

# https://goreleaser.com/customization/changelog/
changelog:
  disable: false
  use: github
  sort: asc
  groups:
    - title: "New Features"
      regexp: "^.*feat[(\\w)]*:+.*$"
      order: 0
    - title: "Bug Fixes"
      regexp: "^.*fix[(\\w)]*:+.*$"
      order: 10
    - title: "Dependencies"
      regexp: "^.*deps[(\\w)]*:+.*$"
      order: 30
    - title: Other
      order: 999
