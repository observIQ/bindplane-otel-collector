name: Tests
on:
  pull_request:

jobs:
  unit-tests:
    if: github.actor != 'dependabot[bot]'
    strategy:
      fail-fast: false
      matrix:
        os: [namespace-profile-bindplane-default-ubuntu-24-04-32x64, namespace-profile-bindplane-default-macos-15, namespace-profile-bindplane-default-windows-2022-32x64]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Sources (Namespace runners)
        if: startsWith(matrix.os, 'namespace-profile-') && matrix.os != 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: namespacelabs/nscloud-checkout-action@v7
      - name: Checkout Sources (Windows)
        if: matrix.os == 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: actions/checkout@v4
      - name: Setup Go (Namespace runners)
        if: startsWith(matrix.os, 'namespace-profile-') && matrix.os != 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false # Use Namespace caching instead
      - name: Set up Go cache (Namespace runners)
        if: startsWith(matrix.os, 'namespace-profile-') && matrix.os != 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: go
      - name: Cache Go modules (Ubuntu)
        if: matrix.os == 'namespace-profile-bindplane-default-ubuntu-24-04-32x64'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /home/runner/go/pkg/mod
      - name: Cache Go modules (macOS)
        if: matrix.os == 'namespace-profile-bindplane-default-macos-15'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /Users/runner/go/pkg/mod
      - name: Setup Go (Windows)
        if: matrix.os == 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false
      - name: Cache Go modules (Windows)
        if: matrix.os == 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\go\pkg\mod
          key: ${{ runner.os }}-go-mod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-mod-
      - name: Cache Go build cache (Windows)
        if: matrix.os == 'namespace-profile-bindplane-default-windows-2022-32x64'
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\go-build
          key: ${{ runner.os }}-go-build-${{ hashFiles('**/*.go') }}
          restore-keys: |
            ${{ runner.os }}-go-build-
      - name: Cache Tools (Ubuntu)
        if: matrix.os == 'namespace-profile-bindplane-default-ubuntu-24-04-32x64'
        id: tool-cache-ubuntu
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /home/runner/go/bin
      - name: Cache Tools (macOS)
        if: matrix.os == 'namespace-profile-bindplane-default-macos-15'
        id: tool-cache-macos
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /Users/runner/go/bin
      - name: Cache Tools (Windows)
        if: matrix.os == 'namespace-profile-bindplane-default-windows-2022-32x64'
        id: tool-cache-windows
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\go\bin
          key: ${{ runner.os }}-go-tools-${{ hashFiles('internal/tools/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-
      - name: Install Tools
        run: make install-tools-ci
      - name: Run Tests
        run: make test
      - name: Run Updater Integration Tests (Windows and macOS)
        if: matrix.os == 'namespace-profile-bindplane-default-windows-2022-32x64' || matrix.os == 'namespace-profile-bindplane-default-macos-15'
        run: make test-updater-integration
      - name: Run Updater Integration Tests (Ubuntu)
        if: matrix.os == 'namespace-profile-bindplane-default-ubuntu-24-04-32x64'
        run: sudo make test-updater-integration
