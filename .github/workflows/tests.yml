name: Tests
on:
  pull_request:

jobs:
  # Detect which files changed to skip irrelevant jobs on PRs.
  detect-changes:
    runs-on: namespace-profile-bindplane-default-ubuntu-24-04
    permissions:
      contents: read
      pull-requests: read
    outputs:
      # if this file changed, run all tests. if the makefile changed, run all tests.
      go: ${{ steps.filter.outputs.go || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
      updater: ${{ steps.filter.outputs.updater || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
      receivers: ${{ steps.filter.outputs.receivers || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
      processors: ${{ steps.filter.outputs.processors || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
      exporters: ${{ steps.filter.outputs.exporters || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
      extensions: ${{ steps.filter.outputs.extensions || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
      other: ${{ steps.filter.outputs.other || steps.filter.outputs.tests || steps.filter.outputs.makefile }}
    steps:
      - name: Checkout Sources
        uses: namespacelabs/nscloud-checkout-action@v7
      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # These filters are based on picomatch syntax https://github.com/micromatch/picomatch#
          filters: |
            tests:
              - '.github/workflows/tests.yml'
            makefile:
              - 'Makefile'
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            updater:
              - 'updater/**'
            receivers:
              - 'receiver/**'
            processors:
              - 'processor/**'
            exporters:
              - 'exporter/**'
            extensions:
              - 'extension/**'
            other:
              - '!{receiver,processor,exporter,extension}/**'
    
  unit-tests:
    if: github.actor != 'dependabot[bot]' && needs.detect-changes.outputs.go == 'true'
    needs:
      - detect-changes
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          # Ubuntu - All tests
          - os: ubuntu
            runner: namespace-profile-bindplane-default-ubuntu-24-04-32x64
            test_cmd: sudo make test-updater-integration
          # macOS - All tests
          - os: macos
            runner: namespace-profile-bindplane-default-macos-15
            test_cmd: make test-updater-integration
          # Windows - Receivers
          - os: windows
            target: receivers
            runner: namespace-profile-bindplane-default-windows-2022-8x16
            test_cmd: make test-updater-integration
            skip: ${{ needs.detect-changes.outputs.receivers == 'false' }}
          # Windows - Processors
          - os: windows
            target: processors
            runner: namespace-profile-bindplane-default-windows-2022-8x16
            test_cmd: make test-updater-integration
            skip: ${{ needs.detect-changes.outputs.processors == 'false' }}
          # Windows - Exporters
          - os: windows
            target: exporters
            runner: namespace-profile-bindplane-default-windows-2022-8x16
            test_cmd: make test-updater-integration
            skip: ${{ needs.detect-changes.outputs.exporters == 'false' }}
          # Windows - Extensions
          - os: windows
            target: extensions
            runner: namespace-profile-bindplane-default-windows-2022-8x16
            test_cmd: make test-updater-integration
            skip: ${{ needs.detect-changes.outputs.extensions == 'false' }}
          # Windows - Other
          - os: windows
            target: other
            runner: namespace-profile-bindplane-default-windows-2022-16x32
            test_cmd: make test-updater-integration
            skip: ${{ needs.detect-changes.outputs.other == 'false' }}
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout Sources (Namespace)
        if: matrix.os != 'windows'
        uses: namespacelabs/nscloud-checkout-action@v7

      - name: Checkout Sources (Windows)
        if: matrix.os == 'windows'
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Cache Go (Namespace)
        if: matrix.os != 'windows'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: go

      - name: Cache Go modules (Ubuntu)
        if: matrix.os == 'ubuntu'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /home/runner/go/pkg/mod

      - name: Cache Go modules (macOS)
        if: matrix.os == 'macos'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /Users/runner/go/pkg/mod

      - name: Cache Go modules (Windows)
        if: matrix.os == 'windows'
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\go\pkg\mod
          key: ${{ runner.os }}-go-mod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-mod-

      - name: Cache Go build cache (Windows)
        if: matrix.os == 'windows'
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Local\go-build
          key: ${{ runner.os }}-go-build-${{ hashFiles('**/*.go') }}
          restore-keys: |
            ${{ runner.os }}-go-build-

      - name: Cache Tools (Ubuntu)
        if: matrix.os == 'ubuntu'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /home/runner/go/bin

      - name: Cache Tools (macOS)
        if: matrix.os == 'macos'
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: /Users/runner/go/bin

      - name: Cache Tools (Windows)
        if: matrix.os == 'windows'
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\go\bin
          key: ${{ runner.os }}-go-tools-${{ hashFiles('internal/tools/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install Tools
        run: make install-tools-ci

      - name: Run Component Tests
        if: matrix.os == 'windows' && matrix.skip != 'true'
        run: make test-${{ matrix.target }}
        env:
          TMPDIR: D:\Temp
          TMP: D:\Temp  
          TEMP: D:\Temp
          GOTMPDIR: D:\Temp

      - name: Run All Tests
        if: matrix.os != 'windows'
        run: make test

      # Run updater integration tests for Ubuntu and macOS (always)
      # For Windows, only run when target is 'other'
      - name: Run Updater Integration Tests
        if: ${{ (matrix.os != 'windows' || matrix.target == 'other') && needs.detect-changes.outputs.updater == 'true' }}
        run: ${{ matrix.test_cmd }}

  test-summary:
    if: always()
    needs: [unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
            echo "✅ All tests passed"
          elif [[ "${{ needs.unit-tests.result }}" == "skipped" ]]; then
            echo "⏭️ Tests skipped"
          else
            echo "❌ Tests failed"
            exit 1
          fi
